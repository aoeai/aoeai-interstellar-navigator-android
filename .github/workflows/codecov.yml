#
#      - name: Upload coverage to Codecov
#        uses: codecov/codecov-action@v4-beta
#        with:
#          flags: smart-tests
#          verbose: true
#        env:
#          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

name: Run tests and upload coverage to Codecov
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

#      - name: Build SampleApplication
#        run: ./gradlew --no-daemon assembleDebug

      - name: Test with Gradle
        run: ./gradlew test

#      - name: Upload coverage reports to Codecov
#        run: |
#          # Replace `linux` below with the appropriate OS
#          # Options are `alpine`, `linux`, `macos`, `windows`
#          curl -Os https://uploader.codecov.io/latest/linux/codecov
#          chmod +x codecov
#          ./codecov -t ${CODECOV_TOKEN}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4-beta
        with:
          flags: smart-tests
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

#      - name: Generate JaCoCo test report
#        run: ./gradlew jacocoTestReport

#      - name: Run Coverage
#        run: |
#          ./gradlew testCoverage
#
#      - name: Add coverage to PR
#        id: jacoco
#        uses: madrapps/jacoco-report@v1.6.1
#        with:
#          paths: |
#            ${{ github.workspace }}/**/build/reports/jacoco/prodNormalDebugCoverage/prodNormalDebugCoverage.xml,
#            ${{ github.workspace }}/**/build/reports/jacoco/**/debugCoverage.xml
#          token: ${{ secrets.GITHUB_TOKEN }}
#          min-coverage-overall: 40
#          min-coverage-changed-files: 60

#      - name: Upload coverage to Codecov
#        uses: codecov/codecov-action@v2
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }}
#          files: ./app/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml
#          flags: unittests
#          name: codecov-umbrella
#          fail_ci_if_error: true
#          verbose: true

